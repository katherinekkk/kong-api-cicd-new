trigger:
- main

pool:
  name: Default
  demands: agent.os -equals Linux

variables:
  KONG_ADMIN: "http://192.168.16.144:8001"

steps:

- checkout: self

# 1) Install jq and decK locally (no sudo)
- task: Bash@3
  displayName: "Install jq and decK (no sudo)"
  inputs:
    targetType: inline
    script: |
      set -e

      mkdir -p $(Pipeline.Workspace)/tools
      cd $(Pipeline.Workspace)/tools

      echo "Installing jq..."
      curl -L -o jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
      chmod +x jq

      echo "Installing decK..."
      curl -L -o deck.tar.gz https://github.com/kong/deck/releases/download/v1.35.0/deck_1.35.0_linux_amd64.tar.gz
      tar -xzf deck.tar.gz
      chmod +x deck

      echo "Updating PATH..."
      echo "##vso[task.setvariable variable=PATH]$PATH:$(Pipeline.Workspace)/tools"

      jq --version
      ./deck version

# 2) Generate YAML from JSON
- task: Bash@3
  displayName: "Generate Kong YAML from JSON"
  inputs:
    targetType: inline
    script: |
      export PATH=$(Pipeline.Workspace)/tools:$PATH

      mkdir -p converted-apis

      chmod +x scripts/generate-kong-yaml.sh
      ./scripts/generate-kong-yaml.sh

      echo "Generated files:"
      ls -R

# 3) Test Kong connectivity
- task: Bash@3
  displayName: "Test Kong Admin API connectivity"
  inputs:
    targetType: inline
    script: |
      export PATH=$(Pipeline.Workspace)/tools:$PATH
      ./deck gateway ping --kong-addr $(KONG_ADMIN)

# 4) Deploy to Kong
- task: Bash@3
  displayName: "Deploy API using decK"
  inputs:
    targetType: inline
    script: |
      export PATH=$(Pipeline.Workspace)/tools:$PATH

      ./deck gateway sync \
        --kong-addr $(KONG_ADMIN) \
        converted-apis/onboard-api.yaml
